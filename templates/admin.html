{% extends 'index.html' %}
{% load static %}
{% block title %}
  ADMIN
{% endblock %}
{% block content %}
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/@googlemaps/extended-component-library/0.6.11/index.min.js"></script>
  <div class="container" style="padding-top: 6%;">
    <div class="row width-100">
      <div class="col-md-3">
        <select id="interfaceSelector" class="form-control">
          <option value="warehouseList">Lista Almacenes</option>
          <option value="kardexTotal">Kardex Total</option>
        </select>
      </div>
      <div class="col-md-3 ms-auto" style="display: flex; justify-content: flex-end;">
        <button onclick="abrirModal('{% url 'adminV:warehouses:warehousesCreate' %}')" type="button" class="btn btn-primary" id="openModalButton">Registrar Almacén</button>
      </div>
    </div>

    <!-- Contenedor donde el modal se cargará -->
    <div id="modalContainer"></div>

    <!-- Lista de Almacenes -->
    <div id="warehouseList" class="interface">
      <div class="row">
        {% for almacen in almacenes %}
          <div class="col-md-4">
            <div class="warehouse-card" data-id="{{ almacen.id }}">
              <h5>{{ almacen.nombre }}</h5>
              <p>Stock Disponible: {{ almacen.capadiadOcupadaa }} / {{ almacen.capacidad }}</p>
              <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: {{ almacen.porcentaje_lleno|floatformat:2 }}%;" aria-valuenow="{{ almacen.porcentaje_lleno|floatformat:2 }}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
{% endblock %}

{% block extrajs %}
  <script type="text/javascript">
    const $ = jQuery.noConflict()
    function abrirModal(url) {
      // Cargar el modal desde otro archivo HTML en el contenedor
      $('#modalContainer').load(url, function () {
        // Mostrar el modal después de cargar el contenido
        $('#warehouseModal').modal('show')
      })
    }
    
    let selectedPlace = null
    let placePickerInitialized = false
    
    function initValidation() {
      const warehouseNameInput = document.getElementById('id_warehouse_name')
      const warehouseCapacityInput = document.getElementById('id_warehouse_capacity')
      const placePicker = document.getElementById('directions') // Asegúrate de que el ID coincida
      const submitButton = document.getElementById('botonAdd')
    
      // Función de validación actualizada usando selectedPlace
      const checkFormValidity = () => {
        const nameValid = warehouseNameInput.value.trim() !== ''
        const capacityValid = Number(warehouseCapacityInput.value) > 0
        const addressValid = selectedPlace !== null // Usamos la variable global
        // Puedes opcionalmente extraer latitud y longitud si existen:
        const lat = selectedPlace && selectedPlace.geometry && typeof selectedPlace.geometry.location.lat === 'function' ? selectedPlace.geometry.location.lat() : undefined
        const lng = selectedPlace && selectedPlace.geometry && typeof selectedPlace.geometry.location.lng === 'function' ? selectedPlace.geometry.location.lng() : undefined
    
        console.log('Validación:', {
          nameValid,
          capacityValid,
          addressValid,
          lat,
          lng,
          selectedPlace
        })
    
        submitButton.disabled = !(nameValid && capacityValid && addressValid)
      }
    
      // Configuración para el gmpx-place-picker
      const setupPlacePicker = () => {
        if (!placePickerInitialized && placePicker) {
          placePicker.addEventListener('gmpx-placechange', (event) => {
            // event.detail contiene la información del lugar
            selectedPlace = event.detail
            console.log('Lugar seleccionado:', selectedPlace)
            checkFormValidity()
          })
          placePickerInitialized = true
        }
      }
    
      if (placePicker && submitButton) {
        setupPlacePicker()
        warehouseNameInput.addEventListener('input', checkFormValidity)
        warehouseCapacityInput.addEventListener('input', checkFormValidity)
        checkFormValidity()
      }
    }
    
    // Inicializar la validación al abrir el modal (asegúrate de que se llame en el momento adecuado)
    $(document).on('shown.bs.modal', '#warehouseModal', function () {
      setTimeout(() => {
        initValidation()
      }, 2000) // Asegura que GMaps y el componente se hayan cargado
    })
  </script>
{% endblock %}
